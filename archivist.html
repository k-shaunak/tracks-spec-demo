<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Archivist | Serendipity Engine</title>
    <meta name="description" content="A serendipity engine for exploring the commons of human knowledge, augmented by generative inference.">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    },
                    animation: {
                        'spin-slow': 'spin 3s linear infinite',
                        'fade-in': 'fadeIn 0.5s ease-out',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <!-- React & ReactDOM -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Modular Assets: Data maps in dat/, Styles in src/ -->
    <script src="dat/category_map.js"></script>
    <script src="dat/library_map.js"></script>
    <script src="src/theme_map.js"></script>
    <link rel="stylesheet" href="src/archivist_style.css">

</head>
<body class="transition-colors duration-500">
    <div id="root"></div>

    <!-- Main Logic: Inlined to prevent CORS/XHR errors on file:// protocol -->
    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef, memo, useMemo } = React;
        
        // ==========================================
        // SECTION 1: UTILITIES
        // ==========================================

        const Cache = {
            get: (key) => {
                try {
                    const item = localStorage.getItem(key);
                    if (!item) return null;
                    const parsed = JSON.parse(item);
                    // 24 Hour TTL
                    if (Date.now() > parsed.exp) { localStorage.removeItem(key); return null; }
                    return parsed.val;
                } catch(e) { return null; }
            },
            set: (key, val, ttlMin = 1440) => { // Default 24 hours
                try {
                    const item = { val, exp: Date.now() + ttlMin * 60000 };
                    localStorage.setItem(key, JSON.stringify(item));
                } catch(e) { 
                    localStorage.clear();
                }
            }
        };

        const cleanText = (text) => {
            if (!text) return "";
            return text
                .replace(/\\displaystyle/g, '')
                .replace(/\\mathbb\{.*?\}/g, '')
                .replace(/\[\d+\]/g, '')
                .replace(/\[.*?\]/g, '')
                .replace(/\(listen\)/g, '')
                .replace(/\(\s*\)/g, '')
                .replace(/  /g, ' ')
                .trim();
        };

        const isValidTopic = (title) => {
            if (!title) return false;
            if (title.match(/^\d+$/)) return false; 
            if (title.includes(":")) return false; 
            if (title.startsWith("List of")) return false;
            if (title.startsWith("Index of")) return false;
            return true;
        };

        // --- SESSION SERIALIZATION ---
        const serializeSession = (topics) => {
            if (!topics || !topics.length) return "";
            const minimal = topics.map(t => ({
                t: t.title,
                c: t.category.id,
                d: t.category.domain,
                l: t.category.label
            }));
            try { return btoa(JSON.stringify(minimal)); } 
            catch(e) { console.error("Hash Gen Error", e); return ""; }
        };

        const deserializeSession = (hash) => {
            if (!hash) return null;
            try { return JSON.parse(atob(hash)); } 
            catch(e) { console.error("Hash Parse Error", e); return null; }
        };

        // --- ICON SYSTEM ---
        const FA_MAP = {
            BookOpen: "fa-book-open", RefreshCw: "fa-arrows-rotate", ChevronLeft: "fa-chevron-left",
            ExternalLink: "fa-up-right-from-square", ArrowRight: "fa-arrow-right", Loader2: "fa-spinner fa-spin",
            GraduationCap: "fa-graduation-cap", Library: "fa-building-columns", Feather: "fa-feather-pointed",
            X: "fa-xmark", Brain: "fa-brain", Send: "fa-paper-plane", FileText: "fa-file-lines",
            Lock: "fa-lock", Zap: "fa-bolt", HelpCircle: "fa-circle-question", CheckCircle: "fa-circle-check",
            Network: "fa-circle-nodes", Search: "fa-magnifying-glass", Hash: "fa-hashtag", Atom: "fa-atom",
            Palette: "fa-palette", Landmark: "fa-landmark", Scale: "fa-scale-balanced", Coins: "fa-coins",
            Filter: "fa-filter", Users: "fa-users", Map: "fa-map", Activity: "fa-chart-line",
            Globe: "fa-earth-americas", TrendingUp: "fa-arrow-trend-up", Calendar: "fa-calendar", Book: "fa-book",
            Sparkles: "fa-wand-magic-sparkles", Settings: "fa-gear", Info: "fa-circle-info",
            AlertTriangle: "fa-triangle-exclamation", Scroll: "fa-scroll", PieChart: "fa-chart-pie",
            Cpu: "fa-microchip", Anchor: "fa-anchor", Gavel: "fa-gavel", Briefcase: "fa-briefcase",
            Calculator: "fa-calculator", Building: "fa-building", Vote: "fa-check-to-slot", Rocket: "fa-rocket",
            Leaf: "fa-leaf", Microscope: "fa-microscope", PenTool: "fa-pen-nib", Sigma: "fa-sigma", Divide: "fa-divide",
            Check: "fa-check", Shield: "fa-shield-halved", Fingerprint: "fa-fingerprint", Image: "fa-image",
            Link: "fa-link", Share: "fa-share-nodes", Copy: "fa-copy", ChevronDown: "fa-chevron-down", ChevronUp: "fa-chevron-up"
        };

        const Icon = ({ name, size = 16, className = "" }) => {
            const faClass = FA_MAP[name] || "fa-circle";
            return <i className={`fa-solid ${faClass} ${className}`} style={{ fontSize: size }} aria-hidden="true"></i>;
        };

        // ==========================================
        // SECTION 2: DATA LOADING
        // ==========================================
        
        const MAP_DATA = (typeof window.CATEGORY_MAP !== 'undefined') ? window.CATEGORY_MAP : [];
        const LIBRARIES = (typeof window.LIBRARY_MAP !== 'undefined') ? window.LIBRARY_MAP : {};
        const THEMES = (typeof window.THEME_MAP !== 'undefined') ? window.THEME_MAP : {};

        // Fallback for Themes if file missing
        const UI_THEMES = Object.keys(THEMES).length > 0 ? THEMES : {
            'sepia': { label: 'Sepia', bg: '#f2e8cf', bgCss: 'bg-[#f2e8cf]', text: 'text-[#382b22]', textColor: '#382b22', panel: 'bg-[#fffcf5]', border: 'border-[#d6cbb0]', accent: 'text-[#8c7b60]', button: 'bg-[#2c241b] text-[#f2e8cf]', buttonText: 'text-[#f2e8cf]', font: 'font-serif', pointerColor: '#8c7b60', spinnerBg: 'bg-[#f9f4e6]', link: 'text-[#5c4d3c]', grain: true }
        };

        const LLM_PROVIDERS = {
            gemini: { name: "Google Gemini", url: "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent" },
            groq: { name: "Groq (Llama 3)", url: "https://api.groq.com/openai/v1/chat/completions" }
        };

        const DOMAINS = ["assorted", ...new Set(MAP_DATA.map(c => c.domain))];

        const getDomainIcon = (domain, size = 24, className = "") => {
            switch(domain) {
                case 'Philosophy': return <Icon name="Brain" size={size} className={className} />;
                case 'Science': return <Icon name="Atom" size={size} className={className} />;
                case 'Arts': return <Icon name="PenTool" size={size} className={className} />;
                case 'History': return <Icon name="Landmark" size={size} className={className} />;
                case 'Law': return <Icon name="Gavel" size={size} className={className} />;
                case 'Economics': return <Icon name="Coins" size={size} className={className} />;
                case 'Finance': return <Icon name="TrendingUp" size={size} className={className} />;
                case 'Social Science': return <Icon name="Users" size={size} className={className} />;
                case 'Politics': return <Icon name="Vote" size={size} className={className} />;
                case 'Mathematics': return <Icon name="Calculator" size={size} className={className} />;
                default: return <Icon name="BookOpen" size={size} className={className} />;
            }
        };

        // ==========================================
        // SECTION 3: API LOGIC
        // ==========================================

        const fetchWiki = async (params) => {
            const key = `wiki_${JSON.stringify(params)}`;
            const cached = Cache.get(key);
            if (cached) return cached;
            try {
                const res = await fetch(`https://en.wikipedia.org/w/api.php?origin=*&format=json&${new URLSearchParams(params)}`);
                const data = await res.json();
                Cache.set(key, data);
                return data;
            } catch(e) { return null; }
        };

        const fetchTopicBatch = async (sectors, seedMode) => {
            if (!MAP_DATA.length) return []; 

            let selectedCats = [];
            
            if (seedMode === 'assorted') {
                const domains = [...new Set(MAP_DATA.map(c => c.domain))];
                const shuffledDomains = domains.sort(() => 0.5 - Math.random()).slice(0, sectors);
                selectedCats = shuffledDomains.map(dom => {
                    const inDomain = MAP_DATA.filter(c => c.domain === dom);
                    return inDomain[Math.floor(Math.random() * inDomain.length)];
                });
                while(selectedCats.length < sectors) {
                    selectedCats.push(MAP_DATA[Math.floor(Math.random() * MAP_DATA.length)]);
                }
            } else {
                let candidates = MAP_DATA.filter(c => c.domain === seedMode);
                if (!candidates.length) candidates = MAP_DATA;
                const shuffled = candidates.sort(() => 0.5 - Math.random());
                while(selectedCats.length < sectors) {
                    selectedCats.push(shuffled[selectedCats.length % shuffled.length]);
                }
            }

            const membersPromises = selectedCats.map(cat => 
                fetchWiki({ action: 'query', list: 'categorymembers', cmtitle: cat.id, cmlimit: 50, cmtype: 'page' })
                    .then(data => ({ cat, members: data?.query?.categorymembers || [] }))
            );
            const membersResults = await Promise.all(membersPromises);

            const topicRequests = membersResults.map(({ cat, members }) => {
                const valid = members.filter(m => isValidTopic(m.title));
                if (!valid.length) return null;
                const choice = valid[Math.floor(Math.random() * valid.length)];
                return { cat, title: choice.title };
            }).filter(t => t);

            if (topicRequests.length === 0) return [];

            const titlesParam = topicRequests.map(t => t.title).join('|');
            const detailsData = await fetchWiki({ 
                action: 'query', titles: titlesParam, 
                prop: 'extracts|info', inprop: 'length|touched', exintro: true, explaintext: true 
            });
            const pages = detailsData?.query?.pages || {};
            
            return topicRequests.map(req => {
                const page = Object.values(pages).find(p => p.title === req.title);
                return (page && !page.missing) ? { ...page, category: req.cat } : null;
            }).filter(t => t);
        };

        const fetchTopicExtras = async (title) => {
            const key = `extras_${title}`;
            const cached = Cache.get(key);
            if (cached) return cached;
            
            const today = new Date().toISOString().split('T')[0].replace(/-/g,'');
            const monthAgo = new Date(Date.now()-2592000000).toISOString().split('T')[0].replace(/-/g,'');
            
            const [v, s, b, l] = await Promise.all([
                fetch(`https://wikimedia.org/api/rest_v1/metrics/pageviews/per-article/en.wikipedia/all-access/all-agents/${encodeURIComponent(title)}/daily/${monthAgo}/${today}`).then(r=>r.ok?r.json():null).catch(()=>null),
                fetchWiki({ action: 'parse', page: title, prop: 'sections' }),
                fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(title)}&printType=books&maxResults=3`).then(r=>r.json()).catch(()=>({})),
                fetchWiki({ action: 'query', titles: title, prop: 'links', pllimit: 50, plnamespace: 0 })
            ]);

            const res = {
                views: v?.items ? { total: v.items.reduce((a,x)=>a+x.views,0), trend: v.items.map(x=>x.views) } : null,
                sections: s?.parse?.sections?.filter(x=>!['References','See also','External links','Notes'].includes(x.line)).slice(0,5).map(x=>x.line)||[],
                books: b.items || [],
                links: Object.values(l?.query?.pages||{})[0]?.links?.map(x=>x.title).filter(x=>isValidTopic(x)).sort(()=>0.5-Math.random()).slice(0,3)||[]
            };
            Cache.set(key, res);
            return res;
        };

        const callResearchAssistant = async (session, history, context, overridePrompt) => {
            const defaultSys = `Role: Academic Research Assistant. Context: "${context.substring(0, 4000)}...". Guidelines: Answer concisely. Be intellectual.`;
            const systemPrompt = overridePrompt || defaultSys;

            try {
                let text = "The archives are silent.";
                
                if (session.provider === 'gemini') {
                    const contents = [{ role: "user", parts: [{ text: systemPrompt }] }, ...history.map(msg => ({ role: msg.role === 'user' ? 'user' : 'model', parts: [{ text: msg.content }] }))];
                    const url = `${LLM_PROVIDERS.gemini.url}?key=${session.apiKey}`;
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents }) });
                    if (!response.ok) throw new Error("API Error");
                    const data = await response.json();
                    text = data.candidates?.[0]?.content?.parts?.[0]?.text || text;
                } else if (session.provider === 'groq') {
                    const messages = [{ role: "system", content: systemPrompt }, ...history.map(m => ({ role: m.role === 'user' ? 'user' : 'assistant', content: m.content }))];
                    const url = LLM_PROVIDERS.groq.url;
                    const response = await fetch(url, { method: 'POST', headers: { 'Authorization': `Bearer ${session.apiKey}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ model: "llama3-8b-8192", messages }) });
                    if (!response.ok) throw new Error("API Error");
                    const data = await response.json();
                    text = data.choices?.[0]?.message?.content || text;
                }
                return text;
            } catch (error) { return `Connection interrupted: ${error.message}`; }
        };

        // ==========================================
        // SECTION 4: COMPONENTS
        // ==========================================

        const Sparkline = memo(({ data, color }) => {
            if (!data || data.length === 0) return null;
            const max = Math.max(...data);
            const min = Math.min(...data);
            const range = max - min || 1;
            const points = data.map((val, idx) => {
                const x = (idx / (data.length - 1)) * 100;
                const y = 100 - ((val - min) / range) * 100;
                return `${x},${y}`;
            }).join(' ');
            return (
                <div className="h-8 w-full mt-2 relative">
                    <svg className="w-full h-full overflow-visible" viewBox="0 0 100 100" preserveAspectRatio="none">
                        <polyline fill="none" stroke={color || "currentColor"} strokeWidth="2" points={points} vectorEffect="non-scaling-stroke" />
                    </svg>
                </div>
            );
        });

        const ChatModule = ({ topic, session, theme }) => {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const endRef = useRef(null);
            const suggestions = [`What are the main criticisms?`, `Historical context?`, `Key figures involved?`];

            useEffect(() => { setMessages([{ role: 'model', content: `I have analyzed "${topic.title}". Ask me to synthesize key debates or explain concepts.` }]); }, [topic]);
            useEffect(() => { endRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);

            const send = async (txt) => {
                const query = txt || input;
                if (!query.trim() || loading) return;
                const userMsg = { role: 'user', content: query };
                setMessages(p => [...p, userMsg]);
                setInput('');
                setLoading(true);
                const resp = await callResearchAssistant(session, [...messages, userMsg], cleanText(topic.extract));
                setMessages(p => [...p, { role: 'model', content: resp }]);
                setLoading(false);
            };

            return (
                <div className={`rounded-xl shadow-xl border ${theme.border} overflow-hidden flex flex-col h-[500px] ${theme.panel}`}>
                    <div className={`p-4 border-b ${theme.border} flex items-center justify-between bg-opacity-50`}>
                        <div className={`flex items-center gap-2 ${theme.text}`}>
                            <Icon name="Feather" size={16} />
                            <span className="text-xs font-bold uppercase tracking-widest">Librarian</span>
                        </div>
                        <span className={`text-[9px] uppercase tracking-widest ${theme.accent} border ${theme.border} px-2 py-1 rounded-full flex items-center gap-1`}>
                            <Icon name="Sparkles" size={10} /> {session.provider === 'gemini' ? 'Gemini' : 'Llama3'}
                        </span>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                        {messages.map((m, i) => (
                            <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[85%] p-3 text-sm rounded-xl leading-relaxed ${m.role === 'user' ? `${theme.button} ${theme.buttonText} rounded-br-none shadow-sm` : `border ${theme.border} ${theme.text} rounded-bl-none shadow-sm`}`}>{m.content}</div>
                            </div>
                        ))}
                        {loading && <div className={`flex items-center gap-2 ${theme.accent} text-xs pl-2`}><Icon name="Loader2" size={12} className="animate-spin" /> Consulting...</div>}
                        <div ref={endRef} />
                    </div>
                    {messages.length < 3 && !loading && (
                        <div className="px-4 pb-2 flex gap-2 overflow-x-auto no-scrollbar">
                            {suggestions.map((s, i) => (
                                <button key={i} onClick={() => send(s)} className={`whitespace-nowrap px-3 py-1.5 ${theme.bgCss} hover:opacity-80 ${theme.text} text-xs border ${theme.border} rounded-full transition-colors`}>{s}</button>
                            ))}
                        </div>
                    )}
                    <div className={`p-3 border-t ${theme.border} flex gap-2`}>
                        <input value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && send()} placeholder="Ask a deeper question..." className={`flex-1 ${theme.bgCss} rounded-lg px-3 py-2 text-sm outline-none focus:ring-1 focus:ring-stone-400 transition-all ${theme.text}`} />
                        <button onClick={() => send()} disabled={loading} className={`p-2 ${theme.button} rounded-lg transition-colors`}><Icon name="Send" size={14} /></button>
                    </div>
                </div>
            );
        };

        const LibraryList = ({ theme, topicTitle }) => {
            const [openSection, setOpenSection] = useState(null);
            
            const toggle = (key) => setOpenSection(openSection === key ? null : key);

            return (
                <div className={`${theme.panel} rounded-xl border ${theme.border} p-4 shadow-sm`}>
                    <h3 className={`text-[10px] font-bold ${theme.accent} uppercase tracking-widest mb-3 font-sans font-extrabold flex items-center gap-2`}>
                        <Icon name="Library" size={14}/> Curated Archives
                    </h3>
                    <div className="space-y-1">
                        {Object.entries(LIBRARIES).map(([category, links]) => (
                            <div key={category} className={`border ${theme.border} rounded-lg overflow-hidden`}>
                                <button 
                                    onClick={() => toggle(category)}
                                    className={`w-full flex justify-between items-center p-2 text-xs font-bold ${theme.text} hover:bg-black/5 transition-colors`}
                                >
                                    <span>{category}</span>
                                    <Icon name={openSection === category ? "ChevronUp" : "ChevronDown"} size={10} className="opacity-50"/>
                                </button>
                                {openSection === category && (
                                    <div className="p-2 bg-black/5 border-t border-dashed border-stone-300">
                                        <ul className="space-y-2">
                                            {links.map((source, i) => (
                                                <li key={i}>
                                                    <a href={`${source.url}${encodeURIComponent(topicTitle)}`} target="_blank" rel="noreferrer" className={`block text-xs ${theme.accent} hover:${theme.text} hover:underline decoration-dotted`}>
                                                        {source.name} <Icon name="ExternalLink" size={8} className="inline ml-1 opacity-50" />
                                                    </a>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const Dashboard = ({ topic, session, theme, onBack, onNavigate, onToast }) => {
            const [extras, setExtras] = useState(null);
            const [loadingExtras, setLoadingExtras] = useState(true);
            const [aiSynthesis, setAiSynthesis] = useState(null);
            
            useEffect(() => {
                const init = async () => {
                    setLoadingExtras(true);
                    const data = await fetchTopicExtras(topic.title);
                    setExtras(data);
                    
                    if (session.mode === 'augmented') {
                        const prompt = `Act as an expert researcher. Based on the topic "${topic.title}", provide a brief bulleted list of "Key Intellectual Debates" or "Core Controversies" in this field. Do not use markdown. Just plain text bullets.`;
                        const synthesis = await callResearchAssistant(session, [], cleanText(topic.extract), prompt);
                        setAiSynthesis(synthesis);
                    }
                    setLoadingExtras(false);
                };
                init();
            }, [topic, session]);

            const shareDossier = () => {
                const url = `${window.location.origin}${window.location.pathname}?t=${encodeURIComponent(topic.title)}`;
                navigator.clipboard.writeText(url);
                onToast("Dossier Link Copied");
            };

            return (
                <div className="animate-in fade-in slide-in-from-bottom-4 duration-700 max-w-6xl mx-auto w-full pb-20">
                    <div className={`mb-8 border-b ${theme.border} pb-4 flex justify-between items-center`}>
                        <div className="flex items-center gap-4">
                            <button onClick={onBack} className={`group flex items-center ${theme.accent} hover:${theme.text} text-xs font-bold transition-colors uppercase tracking-widest font-sans`}>
                                <Icon name="ChevronLeft" size={14} className="mr-1 group-hover:-translate-x-1 transition-transform" /> Index
                            </button>
                            <span className={`text-[10px] uppercase tracking-widest font-bold ${theme.accent}`}>{session.mode === 'augmented' ? "Scholar's Lens Active" : 'Standard Access'}</span>
                        </div>
                        <button onClick={shareDossier} className={`text-[10px] font-bold uppercase tracking-widest ${theme.accent} hover:${theme.text} flex items-center gap-2 transition-colors`}>
                            <Icon name="Link" size={12} /> Share Dossier
                        </button>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-12">
                        <div className="lg:col-span-4 space-y-6">
                            <div className={`${theme.panel} p-6 shadow-xl shadow-black/5 rounded-xl border ${theme.border} relative overflow-hidden`}>
                                <h3 className={`text-[10px] font-bold ${theme.accent} uppercase tracking-widest mb-6 flex items-center gap-2 font-sans font-extrabold`}>
                                    <Icon name="FileText" size={14} /> Topic Dossier
                                </h3>
                                <div className={`space-y-4 font-sans text-sm ${theme.text} opacity-90 mb-8`}>
                                    <div className={`flex justify-between border-b ${theme.border} pb-2`}>
                                        <span className="text-xs font-medium opacity-60">Full Manuscript</span>
                                        <span className="font-bold">~{Math.ceil((topic.length / 6) / 200)} min</span>
                                    </div>
                                    <div className={`flex justify-between border-b ${theme.border} pb-2`}>
                                        <span className="text-xs font-medium opacity-60">Last Updated</span>
                                        <span className="font-bold">{new Date(topic.touched).toLocaleDateString()}</span>
                                    </div>
                                </div>

                                {extras?.views && (
                                    <div className="mb-8">
                                        <h4 className={`text-[10px] font-bold ${theme.accent} uppercase tracking-widest mb-2 flex items-center gap-2 font-sans font-extrabold`}><Icon name="TrendingUp" size={12} /> Public Interest (30d)</h4>
                                        <div className={`p-3 rounded-lg border ${theme.border} bg-opacity-50`}>
                                            <div className="flex justify-between items-end mb-1"><span className={`text-xl font-bold ${theme.text}`}>{extras.views.total.toLocaleString()}</span><span className={`text-[10px] ${theme.accent}`}>Views</span></div>
                                            <Sparkline data={extras.views.trend} color={theme.textColor} />
                                        </div>
                                    </div>
                                )}

                                <div className="mb-8">
                                    <h4 className={`text-[10px] font-bold ${theme.accent} uppercase tracking-widest mb-3 flex items-center gap-2 font-sans font-extrabold`}>{session.mode === 'augmented' ? <Icon name="Activity" size={12} /> : <Icon name="Map" size={12} />}{session.mode === 'augmented' ? "Intellectual Synthesis" : "Manuscript Structure"}</h4>
                                    <div className={`rounded-lg p-4 border ${theme.border} text-xs leading-relaxed ${theme.text} min-h-[100px] bg-opacity-50`}>
                                        {loadingExtras ? (
                                            <div className={`flex items-center justify-center h-full gap-2 ${theme.accent}`}><Icon name="Loader2" size={12} className="animate-spin"/> Analyzing...</div>
                                        ) : session.mode === 'augmented' ? (
                                            <div className="italic"><p className="mb-2 font-bold not-italic opacity-100">Key Debates & Context:</p>{aiSynthesis}</div>
                                        ) : (
                                            <ul className={`space-y-2 list-disc pl-4 opacity-80`}>{extras?.sections.length > 0 ? extras.sections.map((s, i) => <li key={i}>{s}</li>) : <li className="italic opacity-50">No section data available.</li>}</ul>
                                        )}
                                    </div>
                                </div>

                                <div>
                                    <h4 className={`text-[10px] font-bold ${theme.accent} uppercase tracking-widest mb-3 flex items-center gap-2 font-sans font-extrabold`}><Icon name="Network" size={12} /> Cross-References</h4>
                                    {loadingExtras ? (
                                        <div className="space-y-2">{[1,2,3].map(i => <div key={i} className={`h-8 ${theme.border} bg-opacity-10 bg-black animate-pulse rounded-lg`}></div>)}</div>
                                    ) : (
                                        <div className="flex flex-col gap-2">
                                            {extras?.links.map((link, i) => (
                                                <button key={i} onClick={() => onNavigate(link)} className={`text-left text-xs font-bold ${theme.text} opacity-80 hover:opacity-100 hover:text-indigo-600 p-3 border ${theme.border} rounded-lg transition-all flex items-center justify-between group/link font-sans bg-transparent hover:bg-black/5`}>
                                                    <span className="truncate pr-2">{link}</span><Icon name="ArrowRight" size={12} className={`opacity-0 group-hover/link:opacity-100 -translate-x-2 group-hover/link:translate-x-0 transition-all ${theme.link}`} />
                                                </button>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            {/* Updated Library List - Shows All */}
                            <LibraryList theme={theme} topicTitle={topic.title} />
                        </div>

                        <div className="lg:col-span-8 flex flex-col gap-12">
                            <div>
                                <h1 className={`text-4xl md:text-6xl ${theme.font} ${theme.text} leading-[1.1] mb-8 font-bold`}>{topic.title}</h1>
                                <div className={`prose prose-lg max-w-none mb-8 ${theme.font} ${theme.text} opacity-90`}>
                                    <p className="lead first-letter:text-6xl first-letter:font-serif first-letter:mr-3 first-letter:float-left first-letter:opacity-50 first-letter:leading-[0.8]">
                                        {cleanText(topic.extract) || "No detailed record found."}
                                    </p>
                                </div>
                                <div className={`flex justify-end pt-8 border-t ${theme.border}`}>
                                    <a href={`https://en.wikipedia.org/?curid=${topic.pageid}`} target="_blank" rel="noreferrer" className={`inline-flex items-center gap-3 px-8 py-4 border-2 ${theme.border} ${theme.button} ${theme.buttonText} text-xs uppercase tracking-[0.2em] font-bold transition-all rounded-lg font-sans shadow-md hover:shadow-lg transform hover:-translate-y-0.5`}>
                                        Read Full Manuscript <Icon name="ArrowRight" size={14} strokeWidth={2.5}/>
                                    </a>
                                </div>
                            </div>

                            {extras?.books?.length > 0 && (
                                <div className={`border-t ${theme.border} pt-8`}>
                                    <h3 className={`text-[10px] font-bold ${theme.accent} uppercase tracking-widest mb-6 flex items-center gap-2 font-extrabold`}>
                                        <Icon name="Book" size={14} className="stroke-[2px]"/> Reference Shelf: Essential Monographs
                                    </h3>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        {extras.books.map((b, i) => (
                                            <a key={i} href={b.volumeInfo.infoLink} target="_blank" rel="noreferrer" className={`block ${theme.panel} border ${theme.border} p-4 rounded-xl hover:shadow-lg transition-all group`}>
                                                {b.volumeInfo.imageLinks?.thumbnail ? (
                                                    <img src={b.volumeInfo.imageLinks.thumbnail} alt="" className="h-24 w-auto mb-4 mix-blend-multiply opacity-80 group-hover:opacity-100 transition-opacity shadow-sm" />
                                                ) : (
                                                    <div className={`h-24 w-16 mb-4 ${theme.border} border bg-black/5 flex items-center justify-center`}>
                                                        <Icon name="Image" size={20} className="opacity-20" />
                                                    </div>
                                                )}
                                                <h4 className={`text-sm font-bold ${theme.text} leading-tight mb-1 line-clamp-2`}>{b.volumeInfo.title}</h4>
                                                <p className={`text-xs ${theme.accent} mb-2`}>{b.volumeInfo.authors?.join(', ')}</p>
                                                <p className={`text-[10px] opacity-50 ${theme.text}`}>{b.volumeInfo.publishedDate?.substring(0,4)}</p>
                                            </a>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {session.mode === 'augmented' && (
                                <div className={`border-t-4 border-indigo-900 pt-8 animate-in slide-in-from-bottom-8`}>
                                    <h3 className="text-sm font-bold text-indigo-900 uppercase tracking-widest mb-6 flex items-center gap-2 font-extrabold">
                                        <Icon name="Brain" size={16} className="stroke-[2px]"/> Research Assistant
                                    </h3>
                                    <ChatModule topic={topic} session={session} theme={theme} />
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const SettingsPopover = ({ isOpen, onClose, currentSettings, onUpdate }) => {
            if (!isOpen) return null;
            return (
                <div className="absolute top-full right-0 mt-2 z-[100] w-64 bg-white/95 backdrop-blur-md shadow-2xl rounded-xl border border-stone-200 p-4 font-sans text-stone-900 animate-in fade-in slide-in-from-top-2 origin-top-right">
                    <div className="flex justify-between items-center mb-4 pb-2 border-b border-stone-100">
                        <h3 className="text-xs font-bold uppercase tracking-widest text-stone-500">Configuration</h3>
                        <button onClick={onClose}><Icon name="X" size={14} className="text-stone-400 hover:text-stone-600" /></button>
                    </div>
                    <div className="space-y-4">
                        <div>
                            <label className="text-[10px] font-bold text-stone-400 block mb-2">Interface Theme</label>
                            <div className="flex gap-1">
                                {Object.keys(UI_THEMES).map(t => (
                                    <button key={t} onClick={() => onUpdate('theme', t)} className={`flex-1 py-2 text-[10px] font-bold capitalize rounded-md border transition-all ${currentSettings.theme === t ? 'border-indigo-500 bg-indigo-50 text-indigo-700 shadow-sm' : 'border-stone-200 text-stone-600 hover:bg-stone-50'}`}>{t}</button>
                                ))}
                            </div>
                        </div>
                        <div>
                            <label className="text-[10px] font-bold text-stone-400 block mb-2">Sector Count</label>
                            <div className="flex gap-1">
                                {[3, 4, 5, 6].map(n => (
                                    <button key={n} onClick={() => onUpdate('sectors', n)} className={`flex-1 py-2 text-[10px] font-bold rounded-md border transition-all ${currentSettings.sectors === n ? 'border-indigo-500 bg-indigo-50 text-indigo-700 shadow-sm' : 'border-stone-200 text-stone-600 hover:bg-stone-50'}`}>{n}</button>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const CredentialsModal = ({ isOpen, onClose, onConfirm }) => {
            const [key, setKey] = useState('');
            const [provider, setProvider] = useState('gemini');
            const [showGuide, setShowGuide] = useState(false);
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-stone-950/80 backdrop-blur-md animate-in fade-in">
                    <div className="bg-white max-w-lg w-full p-8 shadow-2xl relative rounded-xl font-sans text-stone-900">
                        <button onClick={onClose} className="absolute top-4 right-4 text-stone-400 hover:text-stone-800 transition-colors"><Icon name="X" size={20} /></button>
                        <div className="flex items-center gap-3 mb-6">
                            <div className="p-2 bg-indigo-50 rounded-lg text-indigo-700"><Icon name="Sparkles" size={24}/></div>
                            <h2 className="text-xl font-bold text-stone-900 tracking-tight">Scholar's Lens</h2>
                        </div>
                        <p className="text-sm text-stone-600 mb-6 leading-relaxed">Activate AI-augmented analysis for <strong className="text-indigo-700">Intellectual Synthesis</strong>.</p>
                        
                        <div className="flex gap-2 mb-4">
                            {Object.keys(LLM_PROVIDERS).map(p => (
                                <button key={p} onClick={() => setProvider(p)} className={`flex-1 py-2 text-xs font-bold border rounded-lg transition-all ${provider === p ? 'bg-indigo-600 text-white border-indigo-600' : 'text-stone-500 border-stone-200 hover:bg-stone-50'}`}>
                                    {LLM_PROVIDERS[p].name}
                                </button>
                            ))}
                        </div>

                        <input type="password" placeholder={`Paste ${provider === 'gemini' ? 'Google AI' : 'Groq'} API Key`} className="w-full p-3 border border-stone-200 rounded-lg mb-4 font-mono text-sm focus:border-indigo-500 outline-none transition-all" value={key} onChange={(e) => setKey(e.target.value)} />
                        <button onClick={() => onConfirm({ apiKey: key, provider })} className="w-full py-3 bg-indigo-600 text-white text-xs uppercase tracking-widest font-bold hover:bg-indigo-700 transition-colors rounded-lg shadow-sm mb-4">Initialize Lens</button>
                        <button onClick={() => setShowGuide(!showGuide)} className="flex items-center gap-2 text-xs font-medium text-stone-400 hover:text-indigo-600 transition-colors mx-auto"><Icon name="HelpCircle" size={14} /> Where do I get a key?</button>
                        {showGuide && <div className="mt-4 p-4 bg-stone-50 text-xs text-stone-500 rounded-lg border border-stone-100 leading-relaxed">
                            {provider === 'gemini' ? <span>1. Visit <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-indigo-600 font-bold underline">Google AI Studio</a>.<br/>2. Create a free API Key.</span> : <span>1. Visit <a href="https://console.groq.com/keys" target="_blank" className="text-indigo-600 font-bold underline">Groq Console</a>.<br/>2. Create a free API Key.</span>}
                        </div>}
                    </div>
                </div>
            );
        };

        const DisclaimerModal = ({ onAccept, theme }) => (
            <div className="fixed inset-0 z-[100] bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
                <div className={`max-w-lg w-full ${theme.panel} ${theme.text} p-8 rounded-xl shadow-2xl border ${theme.border} animate-fade-in font-serif relative`}>
                    <div className={`absolute top-0 left-0 w-full h-1 ${theme.accent.replace('text', 'bg')}`}></div>
                    <div className={`flex items-center gap-3 mb-6 border-b ${theme.border} pb-4`}>
                        <Icon name="Fingerprint" size={24} className={theme.accent} />
                        <h2 className="text-lg font-bold uppercase tracking-widest">Access Protocol</h2>
                    </div>
                    <div className="space-y-4 text-sm leading-relaxed mb-8 font-sans opacity-90">
                        <p><strong>The Archivist</strong> is a serendipity engine that aggregates content from public knowledge bases (Wikipedia, Google Books) and generative inference models.</p>
                        <p>Automated summaries may not reflect current academic consensus. This tool assumes no liability for content accuracy. <span className="font-bold">Always consult primary sources for rigorous study.</span></p>
                        <p className={`text-xs p-2 rounded border ${theme.border} bg-opacity-10`}><strong>AI Notice:</strong> "Scholar's Lens" features utilize external LLMs which may hallucinate facts.</p>
                    </div>
                    <button onClick={onAccept} className={`w-full py-4 ${theme.button} ${theme.buttonText} font-bold uppercase tracking-widest text-xs rounded-lg transition-colors flex items-center justify-center gap-2 font-sans shadow-lg`}>
                        <Icon name="Check" /> Acknowledge & Enter Tool
                    </button>
                </div>
            </div>
        );

        // ==========================================
        // SECTION 5: MAIN APP CONTROLLER
        // ==========================================

        const App = () => {
            const [session, setSession] = useState({ mode: 'plain', apiKey: '', provider: 'gemini' });
            const [showGatekeeper, setShowGatekeeper] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [ack, setAck] = useState(false);
            const [userSettings, setUserSettings] = useState({ theme: 'sepia', sectors: 5 });
            const settingsBtnRef = useRef(null);
            
            const [view, setView] = useState('spinner');
            const [activeTopics, setActiveTopics] = useState([]);
            const [hoveredTopic, setHoveredTopic] = useState(null);
            const [selectedTopic, setSelectedTopic] = useState(null);
            const [rotation, setRotation] = useState(0);
            const [isSpinning, setIsSpinning] = useState(false);
            const [showResult, setShowResult] = useState(false);
            const [loading, setLoading] = useState(true);
            const [seedingMode, setSeedingMode] = useState("assorted");
            const [toast, setToast] = useState(null);

            const theme = UI_THEMES[userSettings.theme] || UI_THEMES['sepia'];

            const showToast = (msg) => {
                setToast(msg);
                setTimeout(() => setToast(null), 3000);
            };

            // OPTIMIZATION: Debounced Hover Telemetry
            // This prevents React from re-rendering the entire component tree on every single pixel of mouse movement
            const hoverTimeoutRef = useRef(null);
            const handleSpinnerHover = (topic) => {
                if (isSpinning) return;
                if (hoverTimeoutRef.current) clearTimeout(hoverTimeoutRef.current);
                hoverTimeoutRef.current = setTimeout(() => {
                    setHoveredTopic(topic);
                }, 40); // 40ms debounce
            };
            
            const clearSpinnerHover = () => {
                if (hoverTimeoutRef.current) clearTimeout(hoverTimeoutRef.current);
                setHoveredTopic(null);
            };

            useEffect(() => {
                document.body.style.backgroundColor = theme.bg;
                if (theme.grain) {
                    document.body.classList.add('grain-overlay');
                    // Using updated static style from archivist_style.css
                } else {
                    document.body.classList.remove('grain-overlay');
                }
                return () => { };
            }, [userSettings.theme, theme]);

            // Unified Navigation (Open Dossier)
            const handleNavigate = async (title) => {
                const d = await fetchWiki({ 
                    action: 'query', titles: title, prop: 'extracts|info|categories', 
                    inprop: 'length|touched', exintro: true, explaintext: true, cllimit: 15 
                });
                const p = Object.values(d?.query?.pages || {})[0];
                
                if (p && !p.missing) {
                    const newTopic = { ...p, category: { domain: "Linked" } };
                    setSelectedTopic(newTopic);
                    setShowResult(true);
                    setView('spinner'); // Ensure base view is spinner
                }
            };

            const loadBatch = useCallback(async (modeOverride, ignoreUrlParams = false) => {
                if (!ack) return;
                setLoading(true);
                
                let loadedFromHash = false;

                if (!ignoreUrlParams) {
                    const urlParams = new URLSearchParams(window.location.search);
                    const topicParam = urlParams.get('t');
                    const sessionHash = urlParams.get('s');

                    if (sessionHash) {
                        const restoredMinimal = deserializeSession(sessionHash);
                        if (restoredMinimal && restoredMinimal.length) {
                             try {
                                const titlesParam = restoredMinimal.map(t => t.t).join('|');
                                const detailsData = await fetchWiki({ 
                                    action: 'query', titles: titlesParam, 
                                    prop: 'extracts|info', inprop: 'length|touched', exintro: true, explaintext: true 
                                });
                                const pages = detailsData?.query?.pages || {};
                                const reconstructed = restoredMinimal.map(min => {
                                    const page = Object.values(pages).find(p => p.title === min.t);
                                    if (!page) return null;
                                    return { ...page, category: { id: min.c, domain: min.d, label: min.l } };
                                }).filter(x => x);
                                
                                if (reconstructed.length > 0) {
                                    setActiveTopics(reconstructed);
                                    loadedFromHash = true;
                                }
                             } catch(e) { console.error("Rehydration failed", e); }
                        }
                    }

                    if (topicParam) {
                        handleNavigate(topicParam);
                    }
                }

                if (!loadedFromHash) {
                    const targetMode = modeOverride || seedingMode;
                    try {
                        const topics = await fetchTopicBatch(userSettings.sectors, targetMode);
                        if (topics.length > 0) setActiveTopics(topics);
                    } catch(e) { console.error(e); }
                }

                setLoading(false);
                setRotation(0);
            }, [seedingMode, userSettings.sectors, ack]);

            useEffect(() => { loadBatch(null, false); }, [loadBatch]);

            const handleDiscard = () => {
                setShowResult(false);
                setSelectedTopic(null); 
                setView('spinner'); 
            };

            const handleRefresh = () => {
                loadBatch(null, true);
                setShowResult(false);
                setSelectedTopic(null);
            };

            const handleShareSession = () => {
                const hash = serializeSession(activeTopics);
                const url = `${window.location.origin}${window.location.pathname}?s=${hash}`;
                navigator.clipboard.writeText(url);
                showToast("Session URL copied to clipboard");
            };

            const handleSpin = () => {
                if (isSpinning || !activeTopics.length) return;
                setIsSpinning(true);
                setShowResult(false);
                const randomIndex = Math.floor(Math.random() * activeTopics.length);
                const segmentAngle = 360 / activeTopics.length;
                const targetAngle = (360 - (randomIndex * segmentAngle)) - (segmentAngle / 2); 
                const finalRot = rotation + (360 * 6) + (targetAngle - (rotation % 360)) + (Math.random() * 4 - 2); 
                setRotation(finalRot);
                setTimeout(() => {
                    setSelectedTopic(activeTopics[randomIndex]);
                    setIsSpinning(false);
                    setShowResult(true);
                }, 4000);
            };

            const handleUrlInput = (url) => {
                if (!url) return;
                try {
                    const match = url.match(/\/wiki\/([^#?]+)/) || url.match(/title=([^&]+)/);
                    const title = match ? decodeURIComponent(match[1]).replace(/_/g, ' ') : url;
                    handleNavigate(title);
                } catch(e) { console.error("Invalid URL", e); }
            };

            const toggleSession = () => {
                if (session.mode === 'augmented') {
                    setSession({ mode: 'plain', apiKey: '', provider: 'gemini' });
                } else {
                    setShowGatekeeper(true);
                }
            };

            const changeSeeding = (e) => {
                const newMode = e.target.value;
                setSeedingMode(newMode);
                loadBatch(newMode, true);
            };

            return (
                <div className={`min-h-screen ${theme.font} ${theme.text} transition-colors duration-500`}>
                    {!ack && <DisclaimerModal onAccept={() => setAck(true)} theme={theme} />}
                    {toast && (
                        <div className="fixed top-24 left-1/2 -translate-x-1/2 z-50 bg-black text-white px-6 py-3 rounded-full shadow-xl animate-fade-in text-xs font-bold uppercase tracking-widest flex items-center gap-2">
                            <Icon name="CheckCircle" size={14} className="text-green-400" /> {toast}
                        </div>
                    )}
                    <nav className={`border-b ${theme.border} px-6 py-4 flex items-center justify-between sticky top-0 z-40 backdrop-blur-sm ${userSettings.theme === 'dark' ? 'bg-black/20' : 'bg-white/10'}`}>
                        <div className="flex items-center gap-3">
                            <Icon name="BookOpen" size={20} className={theme.text} />
                            <span className="font-bold text-lg tracking-widest uppercase hidden md:inline font-sans">The Archivist</span>
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="relative" ref={settingsBtnRef}>
                                <button onClick={() => setShowSettings(!showSettings)} className={`p-2 rounded-lg ${theme.border} border hover:bg-black/5 transition-colors ${showSettings ? 'bg-black/5' : ''}`}>
                                    <Icon name="Settings" size={14} className={theme.accent} />
                                </button>
                                <SettingsPopover isOpen={showSettings} onClose={() => setShowSettings(false)} currentSettings={userSettings} onUpdate={(k, v) => setUserSettings(prev => ({...prev, [k]: v}))} />
                            </div>
                            <button onClick={toggleSession} className={`flex items-center gap-2 px-4 py-2 rounded-lg text-[10px] font-bold uppercase tracking-widest transition-all ${session.mode === 'augmented' ? 'bg-indigo-600 text-white shadow-md shadow-indigo-200' : `${theme.panel} border ${theme.border} ${theme.accent}`}`}>
                                {session.mode === 'augmented' ? <Icon name="Sparkles" size={12} fill="currentColor" /> : <Icon name="Lock" size={12} />}
                                {session.mode === 'augmented' ? "Scholar's Lens" : 'Standard Mode'}
                            </button>
                            {view === 'spinner' && (
                                <button onClick={handleRefresh} disabled={isSpinning || loading} className={`flex items-center gap-2 text-[10px] font-bold uppercase tracking-widest ${theme.accent} hover:${theme.text} disabled:opacity-30 transition-colors`}>
                                   {loading ? <Icon name="Loader2" size={12} className="animate-spin" /> : <Icon name="RefreshCw" size={12} />}
                                   {loading ? 'Retrieving...' : 'Refresh'}
                                </button>
                            )}
                        </div>
                    </nav>

                    <main className="container mx-auto px-4 py-8 md:py-12 flex flex-col items-center justify-center min-h-[calc(100vh-80px)]">
                        {view === 'loading_direct' && (
                            <div className="text-center animate-fade-in">
                                <Icon name="Loader2" size={48} className={`animate-spin mx-auto mb-6 ${theme.accent}`} />
                                <p className={`text-xs font-bold uppercase tracking-widest ${theme.accent}`}>Following Reference...</p>
                            </div>
                        )}

                        {view === 'spinner' && (
                            <div className="w-full max-w-4xl mx-auto flex flex-col items-center animate-in fade-in duration-1000">
                                <div className="mb-12 relative group flex flex-col items-center gap-4">
                                    <div className={`flex items-center gap-3 ${theme.panel} border ${theme.border} rounded-full px-6 py-2 shadow-sm hover:shadow-md transition-shadow`}>
                                        <Icon name="Filter" size={14} className={theme.accent} />
                                        <span className={`text-[10px] uppercase tracking-widest font-bold ${theme.accent}`}>Curatorial Strategy:</span>
                                        <select value={seedingMode} onChange={changeSeeding} disabled={loading || isSpinning} className={`bg-transparent text-xs font-bold ${theme.text} uppercase tracking-widest outline-none cursor-pointer hover:text-indigo-500 appearance-none pr-4`}>
                                            {DOMAINS.map(d => <option key={d} value={d}>{d}</option>)}
                                        </select>
                                        <Icon name="ChevronLeft" size={10} className={`${theme.accent} -rotate-90 absolute right-6 pointer-events-none`} />
                                    </div>
                                    
                                    <button 
                                        onClick={handleShareSession}
                                        disabled={loading || !activeTopics.length}
                                        className={`flex items-center gap-2 text-[10px] uppercase tracking-widest font-bold ${theme.accent} hover:text-indigo-600 transition-colors opacity-60 hover:opacity-100`}
                                    >
                                        <Icon name="Share" size={12} /> Share Session Hash
                                    </button>
                                </div>

                                <div className="relative w-80 h-80 md:w-[450px] md:h-[450px] mb-16">
                                   {loading || !activeTopics.length ? (
                                     <div className="absolute inset-0 flex items-center justify-center flex-col gap-4">
                                         <Icon name="Loader2" size={48} className={`animate-spin ${theme.accent}`} />
                                         {!MAP_DATA.length && <p className={`text-xs ${theme.accent}`}>Loading Archives...</p>}
                                     </div>
                                   ) : (
                                     <>
                                       <div className="absolute -top-10 left-1/2 -translate-x-1/2 z-20 flex flex-col items-center">
                                          <div className={`w-px h-8 ${theme.pointerColor}`} style={{backgroundColor: theme.pointerColor}}></div>
                                          <div className={`w-3 h-3 rotate-45 -mt-1.5 ${theme.pointerColor}`} style={{backgroundColor: theme.pointerColor}}></div>
                                       </div>
                                       <div className={`w-full h-full rounded-full border-[12px] shadow-2xl relative transition-transform duration-[4000ms] cubic-bezier(0.2, 0.8, 0.2, 1) overflow-hidden ${theme.panel}`} style={{ borderColor: theme.border.includes('-') ? theme.border.split('-')[1] : '#d6cbb0', transform: `rotate(${rotation}deg)` }}>
                                         <div className={`absolute inset-0 m-2 rounded-full border ${theme.border} opacity-50`}></div>
                                         <div className={`absolute inset-0 m-32 rounded-full border ${theme.border} bg-opacity-20`}></div>
                                         {activeTopics.map((topic, index) => {
                                            const count = activeTopics.length;
                                            const rotate = index * (360 / count);
                                            return (
                                              <div 
                                                key={topic.pageid} 
                                                className="absolute top-0 right-0 w-[50%] h-[50%] origin-bottom-left" 
                                                style={{ transform: `rotate(${rotate}deg) skewY(-${90 - (360/count)}deg)` }}
                                              >
                                                <div 
                                                    className={`w-full h-full border-l ${theme.border} flex items-center justify-center pt-16 hover:bg-black/5 transition-colors cursor-pointer group`} 
                                                    style={{ transform: `skewY(${90 - (360/count)}deg) rotate(${360 / count / 2}deg)` }}
                                                    onMouseEnter={() => handleSpinnerHover(topic)}
                                                    onMouseLeave={clearSpinnerHover}
                                                >
                                                   <div className={`transform -rotate-90 translate-x-12 w-32 flex flex-col items-center justify-center ${theme.text} opacity-80 group-hover:opacity-100 group-hover:scale-110 transition-all`}>
                                                      {getDomainIcon(topic.category?.domain, count > 4 ? 24 : 32, "stroke-[1.5]")}
                                                   </div>
                                                </div>
                                              </div>
                                            );
                                         })}
                                       </div>
                                       
                                       <div className={`absolute top-1/2 left-1/2 w-32 h-32 ${theme.spinnerBg} rounded-full transform -translate-x-1/2 -translate-y-1/2 shadow-[inset_0_2px_4px_rgba(0,0,0,0.1)] border ${theme.border} flex flex-col items-center justify-center p-4 text-center z-30 transition-all duration-300`}>
                                         {hoveredTopic && !isSpinning ? (
                                            <div className="animate-fade-in">
                                                <p className={`text-[9px] font-bold uppercase tracking-widest ${theme.accent} mb-1 line-clamp-1`}>{hoveredTopic.category?.label}</p>
                                                <p className={`text-xs font-serif font-bold ${theme.text} leading-tight line-clamp-2`}>{hoveredTopic.title}</p>
                                            </div>
                                         ) : (
                                            <Icon name="Search" size={24} className={`${theme.accent} opacity-50`}/>
                                         )}
                                       </div>
                                     </>
                                   )}
                                </div>

                                <div className="flex flex-col items-center w-full max-w-lg gap-8">
                                    <button onClick={handleSpin} disabled={isSpinning || loading || !activeTopics.length} className={`w-full px-12 py-4 border ${theme.border} text-xs uppercase tracking-[0.25em] font-bold transition-all ${theme.panel} ${theme.text} hover:opacity-80 rounded shadow-sm hover:shadow-xl ${isSpinning ? 'opacity-50' : ''}`}>
                                      {isSpinning ? 'Consulting Index...' : 'Query The Index'}
                                    </button>

                                    {/* Direct Access Module */}
                                    <div className={`w-full p-1 rounded-xl ${theme.border} border bg-opacity-50 flex flex-col items-center transition-all animate-fade-in hover:shadow-md`}>
                                        <div className={`w-full ${theme.panel} rounded-lg p-3 flex flex-col sm:flex-row items-center gap-3`}>
                                            <div className="hidden sm:block p-2 bg-black/5 rounded text-indigo-500">
                                                <Icon name="Link" size={14} />
                                            </div>
                                            <div className="w-full flex-1">
                                                <input 
                                                    type="text" 
                                                    placeholder="Paste direct Wikipedia URL or Topic Title..." 
                                                    className={`w-full bg-transparent text-sm font-bold ${theme.text} outline-none placeholder:opacity-40 placeholder:font-normal font-sans text-center sm:text-left`}
                                                    onKeyDown={(e) => e.key === 'Enter' && handleUrlInput(e.target.value)}
                                                />
                                            </div>
                                            <button 
                                                onClick={(e) => handleUrlInput(e.target.previousSibling.querySelector('input').value)} 
                                                className={`w-full sm:w-auto px-3 py-1.5 rounded text-[10px] font-bold uppercase tracking-wider ${theme.text} hover:bg-black/5 transition-colors border border-transparent hover:${theme.border}`}
                                            >
                                                Load Dossier
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {view === 'dashboard' && selectedTopic && (
                            <Dashboard topic={selectedTopic} session={session} theme={theme} onBack={handleDiscard} onNavigate={handleNavigate} onToast={showToast} />
                        )}
                    </main>

                    {showResult && view === 'spinner' && selectedTopic && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-6 bg-black/80 backdrop-blur-sm animate-in fade-in">
                            <div className={`${theme.panel} max-w-md w-full p-12 shadow-2xl relative rounded-xl text-center border ${theme.border}`}>
                                <div className={`absolute -top-3 left-1/2 -translate-x-1/2 ${theme.button} ${theme.buttonText} px-4 py-1.5 text-[10px] uppercase tracking-widest font-bold rounded-full shadow-lg`}>File Retrieved</div>
                                
                                <h2 className={`text-3xl font-serif ${theme.text} mb-6 leading-tight mt-6`}>{selectedTopic.title}</h2>
                                <div className={`w-8 h-1 ${theme.border} border-t-4 mx-auto mb-8`}></div>
                                <p className={`${theme.accent} mb-10 leading-relaxed font-serif italic text-sm`}>"{cleanText(selectedTopic.extract).substring(0, 150)}..."</p>
                                <button onClick={() => setView('dashboard')} className={`w-full py-4 ${theme.button} ${theme.buttonText} text-[10px] uppercase tracking-[0.2em] transition-colors rounded-lg font-bold shadow-xl border-none`}>Examine File</button>
                                <button onClick={handleDiscard} className={`mt-4 ${theme.accent} hover:${theme.text} text-[10px] uppercase tracking-widest block w-full`}>Discard & Return</button>
                            </div>
                        </div>
                    )}

                    <CredentialsModal isOpen={showGatekeeper} onClose={() => setShowGatekeeper(false)} onConfirm={(creds) => { setSession({ mode: 'augmented', apiKey: creds.apiKey, provider: creds.provider }); setShowGatekeeper(false); }} />
                    
                    <div className={`mt-20 pt-8 pb-4 text-center opacity-60 hover:opacity-100 transition-opacity border-t ${theme.border} mx-auto max-w-4xl`}>
                        <div className="flex flex-col items-center gap-2">
                            <Icon name="AlertTriangle" size={14} className={theme.accent} />
                            <p className={`text-[10px] uppercase tracking-widest font-bold ${theme.accent}`}>System Notice & Disclaimer</p>
                            <p className={`text-xs ${theme.text} leading-relaxed max-w-2xl px-4`}>
                                The Archivist is a demonstration interface aggregating content from public APIs (Wikipedia, Google Books, Gemini). Information retrieved automatically may not reflect current academic consensus. This tool assumes no liability for content generated or its accuracy. For rigorous study, please consult primary sources and curated academic repositories.
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
